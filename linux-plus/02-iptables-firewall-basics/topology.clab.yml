name: iptables-firewall-basics

topology:
  nodes:
    # Firewall
    firewall:
      kind: linux
      image: alpine:latest
      exec:
        - apk update
        - apk add --no-cache iproute2 iputils iptables nginx tcpdump busybox-extras
        - ip addr add 10.1.1.1/24 dev eth1
        - ip addr add 10.2.2.1/24 dev eth2
        - sysctl -w net.ipv4.ip_forward=1
        # Default DROP policy
        - iptables -P INPUT ACCEPT
        - iptables -P FORWARD DROP
        - iptables -P OUTPUT ACCEPT
        # Allow established/related connections
        - iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
        # Allow HTTP from client to webserver
        - iptables -A FORWARD -i eth1 -o eth2 -p tcp --dport 80 -j ACCEPT
        # Allow ping from client to webserver
        - iptables -A FORWARD -i eth1 -o eth2 -p icmp -j ACCEPT

    # Webserver
    webserver:
      kind: linux
      image: alpine:latest
      exec:
        - apk update
        - apk add --no-cache iproute2 iputils nginx busybox-extras
        - ip addr add 10.2.2.10/24 dev eth1
        - ip route replace default via 10.2.2.1
        # Start nginx
        - mkdir -p /run/nginx /var/www/html
        - echo "<h1>Welcome to the webserver!</h1>" > /var/www/html/index.html
        - nginx

    # Client
    client:
      kind: linux
      image: alpine:latest
      exec:
        - apk update
        - apk add --no-cache iproute2 iputils tcpdump curl nmap busybox-extras
        - ip addr add 10.1.1.10/24 dev eth1
        - ip route replace default via 10.1.1.1

  links:
    - endpoints: ["firewall:eth1", "client:eth1"]
    - endpoints: ["firewall:eth2", "webserver:eth1"]
