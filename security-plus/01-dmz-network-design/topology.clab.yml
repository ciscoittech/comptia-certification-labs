name: dmz-network-design

topology:
  nodes:
    # Firewall (3 interfaces)
    firewall:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iptables tcpdump
        # External interface
        - ip addr add 203.0.113.1/24 dev eth1
        # DMZ interface
        - ip addr add 10.10.10.1/24 dev eth2
        # Internal interface
        - ip addr add 192.168.1.1/24 dev eth3
        # Enable forwarding
        - sysctl -w net.ipv4.ip_forward=1
        # Default DROP
        - iptables -P FORWARD DROP
        # Allow established/related
        - iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
        # External -> DMZ: Allow HTTP
        - iptables -A FORWARD -i eth1 -o eth2 -p tcp --dport 80 -j ACCEPT
        # DMZ -> Internal: Allow MySQL
        - iptables -A FORWARD -i eth2 -o eth3 -p tcp --dport 3306 -j ACCEPT
        # Internal -> DMZ: Allow all
        - iptables -A FORWARD -i eth3 -o eth2 -j ACCEPT
        # Internal -> External: Allow all
        - iptables -A FORWARD -i eth3 -o eth1 -j ACCEPT

    # DMZ Webserver
    dmz-web:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils nginx mysql-client
        - ip addr add 10.10.10.10/24 dev eth1
        - ip route add default via 10.10.10.1
        - mkdir -p /run/nginx
        - echo "<h1>DMZ Webserver</h1>" > /usr/share/nginx/html/index.html
        - nginx

    # Internal Database
    internal-db:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils mariadb mariadb-client
        - ip addr add 192.168.1.10/24 dev eth1
        - ip route add default via 192.168.1.1
        # Initialize database
        - mkdir -p /run/mysqld /var/lib/mysql
        - chown -R mysql:mysql /run/mysqld /var/lib/mysql
        - mysql_install_db --user=mysql --datadir=/var/lib/mysql > /dev/null 2>&1 || true
        - nohup mysqld --user=mysql --datadir=/var/lib/mysql > /dev/null 2>&1 &

    # Internal Client
    internal-client:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils curl
        - ip addr add 192.168.1.20/24 dev eth1
        - ip route add default via 192.168.1.1

    # External Client
    external-client:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils curl
        - ip addr add 203.0.113.10/24 dev eth1
        - ip route add default via 203.0.113.1

  links:
    - endpoints: ["firewall:eth1", "external-client:eth1"]
    - endpoints: ["firewall:eth2", "dmz-web:eth1"]
    - endpoints: ["firewall:eth3", "internal-client:eth1"]
    - endpoints: ["firewall:eth3", "internal-db:eth1"]
