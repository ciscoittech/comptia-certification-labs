name: network-segmentation-zones

topology:
  nodes:
    # Firewall/Router
    firewall:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iptables tcpdump
        # HR VLAN 10
        - ip addr add 10.10.0.1/24 dev eth1
        # Engineering VLAN 20
        - ip addr add 10.20.0.1/24 dev eth2
        # Guest VLAN 30
        - ip addr add 10.30.0.1/24 dev eth3
        # Internet interface
        - ip addr add 203.0.113.1/24 dev eth4
        # Enable forwarding
        - sysctl -w net.ipv4.ip_forward=1
        # Default DROP between VLANs
        - iptables -P FORWARD DROP
        - iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
        # HR and Engineering can reach internet
        - iptables -A FORWARD -s 10.10.0.0/24 -o eth4 -j ACCEPT
        - iptables -A FORWARD -s 10.20.0.0/24 -o eth4 -j ACCEPT
        # Guest can reach internet (limited)
        - iptables -A FORWARD -s 10.30.0.0/24 -o eth4 -p tcp --dport 80 -j ACCEPT
        - iptables -A FORWARD -s 10.30.0.0/24 -o eth4 -p tcp --dport 443 -j ACCEPT
        # Block HR <-> Engineering
        - iptables -A FORWARD -s 10.10.0.0/24 -d 10.20.0.0/24 -j DROP
        - iptables -A FORWARD -s 10.20.0.0/24 -d 10.10.0.0/24 -j DROP
        # Block Guest from internal networks
        - iptables -A FORWARD -s 10.30.0.0/24 -d 10.10.0.0/24 -j DROP
        - iptables -A FORWARD -s 10.30.0.0/24 -d 10.20.0.0/24 -j DROP

    # HR Client
    hr-client:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils curl
        - ip addr add 10.10.0.10/24 dev eth1
        - ip route add default via 10.10.0.1

    # Engineering Client
    eng-client:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils curl
        - ip addr add 10.20.0.10/24 dev eth1
        - ip route add default via 10.20.0.1

    # Guest Client
    guest-client:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils curl
        - ip addr add 10.30.0.10/24 dev eth1
        - ip route add default via 10.30.0.1

    # Internet Server
    internet-server:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils python3
        - ip addr add 203.0.113.10/24 dev eth1
        - ip route add default via 203.0.113.1
        - nohup python3 -m http.server 80 > /dev/null 2>&1 &

  links:
    - endpoints: ["firewall:eth1", "hr-client:eth1"]
    - endpoints: ["firewall:eth2", "eng-client:eth1"]
    - endpoints: ["firewall:eth3", "guest-client:eth1"]
    - endpoints: ["firewall:eth4", "internet-server:eth1"]
