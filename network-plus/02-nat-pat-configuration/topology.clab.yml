name: nat-pat-configuration

topology:
  nodes:
    # Router with NAT/PAT capabilities
    router:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iptables tcpdump
        # Internal interface
        - ip addr add 10.1.1.1/24 dev eth1
        # External interface (simulated public IP)
        - ip addr add 203.0.113.1/24 dev eth2
        # Enable IP forwarding
        - sysctl -w net.ipv4.ip_forward=1
        # Configure NAT (MASQUERADE - PAT)
        - iptables -t nat -A POSTROUTING -o eth2 -j MASQUERADE
        # Allow forwarding from internal to external
        - iptables -A FORWARD -i eth1 -o eth2 -j ACCEPT
        - iptables -A FORWARD -i eth2 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT

    # Internal client
    internal-client:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils tcpdump curl
        - ip addr add 10.1.1.10/24 dev eth1
        - ip route add default via 10.1.1.1

    # External server (simulates internet server)
    external-server:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils tcpdump python3
        - ip addr add 203.0.113.10/24 dev eth1
        - ip route add default via 203.0.113.1
        # Start simple HTTP server
        - nohup python3 -m http.server 80 > /dev/null 2>&1 &

  links:
    - endpoints: ["router:eth1", "internal-client:eth1"]
    - endpoints: ["router:eth2", "external-server:eth1"]
